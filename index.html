<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@fb96ab2/dist/aframe-extras.js"></script>
    <script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <a-scene id="first">
      <!-- 에셋 제작 -->
      <a-asset>
        <a-asset-item
          id="character"
          src="https://cdn.glitch.global/6fa6aec4-5e4b-465e-ae5e-092f559a7f71/human.glb?v=1688484500807"
        ></a-asset-item>
        <a-asset-item id="npc" src="./glb/human2.glb"></a-asset-item>
        <a-asset-item
          id="map"
          src="https://cdn.glitch.me/6fa6aec4-5e4b-465e-ae5e-092f559a7f71/metaverse.glb?v=1688481055830"
        ></a-asset-item>
        <a-asset-item
          id="nav-mesh"
          src="https://cdn.glitch.global/6fa6aec4-5e4b-465e-ae5e-092f559a7f71/nav.glb?v=1688481354605"
        ></a-asset-item>
      </a-asset>
      <!-- 이렇게 들어가야 카메라가 움직이는것을 받아올 수 있음 -->
      <a-entity
        id="rig"
        raycaster-decteted
        navmesh-constraint="navmesh:.navmesh; fall: 3; height: 0;"
        nav-agent
        movement-controls="constrainToNavMesh: true; speed:0.5"
        look-controls
        rotation-reader
      >
        <a-entity
          id="player"
          gltf-model="#character"
          animation-mixer="clip: default;"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.4 0.4 0.4"
        ></a-entity>
        <a-entity camera id="camera" rotation="0 0 0" position="0 2 8">
          <a-cursor
            geometry="primitive: ring; radiusInner: 0; radiusOuter: 0"
            cursor="rayOrigin: mouse;"
            raycaster=" objects : .clickable; far : 1000;"
          ></a-cursor>
        </a-entity>
      </a-entity>

      <a-entity
        class="navmesh"
        nav-mesh
        gltf-model="#nav-mesh"
        scale="1.4 1.4 1.4"
        position="0 0 0"
        visible="false"
      ></a-entity>
      <a-entity
        class="map"
        gltf-model="#map"
        scale="1.4 1.4 1.4"
        position="0 0 0"
        visible="true"
        rotation="0 0 0"
      ></a-entity>

      <a-sky color="#99ccff" radius="400"></a-sky>
    </a-scene>
  </body>
  <script>
    // 소켓 열기
    let socket = io("http://localhost:8080");
    let data = { id: null, position: null, rotation: null };

    // 전체 세션 받아올 때 (상자 생성)
    socket.on("current-sessions", function (result) {
      for (let i in result) {
        if (result[i] != socket.id) {
          // 자기 자신이 아니라면
          $("a-scene").append(
            '<a-entity gltf-model = "https://cdn.glitch.global/6fa6aec4-5e4b-465e-ae5e-092f559a7f71/human.glb?v=1688484500807" scale = "0.4 0.4 0.4" id="' +
              result[i] +
              '" position="0 0 0"></a-entity>'
          );
        }
      }
    });

    // 나간 세션 받아올 때 (상자 삭제)
    socket.on("removed-sessions", function (result) {
      let _target = $("#" + result)[0];
      _target.remove();
    });

    // 다른 상자 데이터 받아올 때
    socket.on("server-to-client", function (result) {
      let _id = result.id;
      let _position = result.position;
      let _rotation = result.rotation;
      let _target = $("#" + _id)[0];
      if (_target != null) {
        // 자기 자신은 상자가 없으므로 제외
        _target.setAttribute("position", _position); // json 형태를 쓰려면 vanilla의 setAttribute만 작동
        _target.setAttribute("rotation", _rotation);
        console.log(_rotation.x);
      }
      // console.log(_rotation);
    });

    // 50ms마다 전송
    setInterval(function () {
      let camera = document.querySelector("#rig"); // 카메라의 위치/회전 데이터 받아오기
      data.id = socket.id;
      data.position = camera.object3D.position;
      data.rotation = {
        // rotation만 받는 데이터가 다르므로 맞춰주기
        x: 0,
        y: (camera.object3D.rotation.y * 180) / Math.PI,
        z: (camera.object3D.rotation.z * 180) / Math.PI,
      };
      socket.emit("client-to-server", data);
    }, 50);
  </script>
</html>
